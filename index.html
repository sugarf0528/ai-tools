<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ‰¹é‡ç”Ÿäº§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .task-card { height: 320px; display: flex; flex-direction: column; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .task-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .media-box { height: 180px; background-color: #f8fafc; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 0.5rem; border: 1px dashed #e2e8f0; }
        video, img { max-height: 100%; max-width: 100%; object-fit: contain; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div class="flex flex-col md:flex-row h-screen">
        <div class="w-full md:w-80 bg-white shadow-2xl p-6 overflow-y-auto z-10 border-r border-slate-200">
            <h1 class="text-xl font-bold mb-6 flex items-center gap-2">
                <span class="p-2 bg-indigo-600 rounded-lg text-white text-xs">AI</span> 
                æ‰¹é‡ç”Ÿäº§ä¸­å¿ƒ
            </h1>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">API Access Key</label>
                    <input type="password" id="apiKey" class="w-full p-2 border rounded bg-slate-50 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="sk-xxxx...">
                </div>

                <div class="flex p-1 bg-slate-100 rounded-lg">
                    <button onclick="switchTab('video')" id="tabBtn-video" class="flex-1 py-1.5 text-xs rounded-md transition-all duration-200 bg-white shadow-sm font-bold text-indigo-600">è§†é¢‘ç”Ÿæˆ</button>
                    <button onclick="switchTab('draw')" id="tabBtn-draw" class="flex-1 py-1.5 text-xs rounded-md transition-all duration-200 text-slate-500">AI ç»˜ç”»</button>
                </div>

                <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-100">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs font-bold text-indigo-600">å•ç»„ç”Ÿæˆæ•°é‡</label>
                        <span id="batchVal" class="text-xs font-mono bg-indigo-200 px-2 rounded-full text-indigo-700">1</span>
                    </div>
                    <input type="range" id="batchCount" min="1" max="50" value="1" oninput="document.getElementById('batchVal').innerText=this.value" class="w-full h-1.5 bg-indigo-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <div id="panel-video" class="space-y-3">
                    <label class="block text-[10px] font-bold text-slate-400 mb-1">è§†é¢‘æ¯”ä¾‹</label>
                    <select id="vRatio" class="w-full p-2 border rounded text-sm bg-white">
                        <option value="9:16">ç«–å± 9:16</option>
                        <option value="16:9">æ¨ªå± 16:9</option>
                    </select>
                    <input type="file" id="vFiles" class="text-[10px] w-full" multiple>
                </div>

                <div id="panel-draw" class="hidden space-y-3 border-t pt-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1">è¾“å‡ºæ¯”ä¾‹ (aspectRatio)</label>
                        <select id="dRatio" class="w-full p-2 border rounded text-sm bg-white">
                            <option value="auto">æ™ºèƒ½è‡ªåŠ¨ (Auto)</option>
                            <option value="1:1">æ­£æ–¹å½¢ 1:1</option>
                            <option value="16:9">æ¨ªå± 16:9</option>
                            <option value="9:16">ç«–å± 9:16</option>
                            <option value="4:3">ç”»å¹… 4:3</option>
                            <option value="3:4">ç”»å¹… 3:4</option>
                            <option value="21:9">å®½å± 21:9</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1">å‚è€ƒå›¾ç‰‡ (é€‰å¡«ï¼Œæ”¯æŒå¤šå¼ )</label>
                        <input type="file" id="dFiles" class="text-[10px] w-full" multiple>
                    </div>
                    <p class="text-[9px] text-slate-400 italic">* å·²é”å®šæ¨¡å‹: Nano Pro | åˆ†è¾¨ç‡: 1K</p>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-400 mb-1">æç¤ºè¯ (æ¯è¡Œå¼€å¯ä¸€ä¸ªä»»åŠ¡)</label>
                    <textarea id="prompt" class="w-full p-2 border rounded h-32 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ä¸€åªåœ¨èµ›åšæœ‹å…‹åŸå¸‚è·‘é…·çš„çŒ«..."></textarea>
                </div>
                
                <button id="mainBtn" onclick="startBatchTasks()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg transition-all flex justify-center items-center gap-2">
                    <span>ğŸš€ å¼€å¯æ‰¹é‡ç”Ÿæˆ</span>
                </button>
                
                <button onclick="clearHistory()" class="w-full py-2 text-[10px] text-slate-400 hover:text-red-500">ğŸ—‘ï¸ æ¸…ç©ºä»»åŠ¡è®°å½•</button>
            </div>
        </div>

        <div class="flex-1 p-6 overflow-y-auto bg-slate-50">
            <h2 class="text-lg font-bold text-slate-700 mb-6">ğŸ“‹ å®æ—¶ç”Ÿäº§é˜Ÿåˆ—</h2>
            <div id="taskGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </div>
    </div>

    <script>
        let currentTab = 'video';
        let tasks = JSON.parse(localStorage.getItem('grsai_tasks_v4')) || [];
        const API_HOST = "https://grsai.dakka.com.cn";

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('panel-video').classList.toggle('hidden', tab !== 'video');
            document.getElementById('panel-draw').classList.toggle('hidden', tab !== 'draw');
            document.getElementById('tabBtn-video').className = tab === 'video' ? "flex-1 py-1.5 text-xs rounded-md bg-white shadow-sm font-bold text-indigo-600" : "flex-1 py-1.5 text-xs rounded-md text-slate-500";
            document.getElementById('tabBtn-draw').className = tab === 'draw' ? "flex-1 py-1.5 text-xs rounded-md bg-white shadow-sm font-bold text-indigo-600" : "flex-1 py-1.5 text-xs rounded-md text-slate-500";
        }

        async function startBatchTasks() {
            const key = document.getElementById('apiKey').value;
            const promptText = document.getElementById('prompt').value.trim();
            const countPerPrompt = parseInt(document.getElementById('batchCount').value) || 1;

            if(!key || !promptText) return alert("è¯·å¡«å†™ API Key å’Œæç¤ºè¯");

            const prompts = promptText.split('\n').filter(p => p.trim() !== "");
            
            // å›¾ç‰‡å¤„ç†
            let imageAssets = [];
            const fileInput = currentTab === 'video' ? document.getElementById('vFiles') : document.getElementById('dFiles');
            if(fileInput.files.length > 0) {
                imageAssets = await Promise.all(Array.from(fileInput.files).map(f => fileToBase64(f)));
            }

            for (let p of prompts) {
                for (let i = 0; i < countPerPrompt; i++) {
                    const taskId = "T_" + Date.now() + "_" + Math.random().toString(36).substr(2, 4);
                    const taskObj = { id: taskId, prompt: p, status: 'running', progress: 0, url: null, type: currentTab, time: new Date().toLocaleTimeString() };
                    
                    tasks.unshift(taskObj);
                    renderAllTasks();

                    // æ„å»ºè¯·æ±‚å‚æ•°
                    let payload = {
                        prompt: p,
                        webHook: "-1" 
                    };

                    if (currentTab === 'video') {
                        payload.model = "sora-2";
                        payload.aspectRatio = document.getElementById('vRatio').value;
                        payload.duration = 15;
                        if(imageAssets.length > 0) payload.url = imageAssets[i % imageAssets.length];
                    } else {
                        // ç»˜ç”»å‚æ•°ï¼šé”å®š nano-banana-pro å’Œ 1K
                        payload.model = "nano-banana-pro";
                        payload.imageSize = "1K";
                        payload.aspectRatio = document.getElementById('dRatio').value;
                        if(imageAssets.length > 0) payload.urls = imageAssets;
                    }

                    callApi(taskId, payload, key);
                    await new Promise(r => setTimeout(r, 300)); 
                }
            }
        }

        async function callApi(taskId, payload, key) {
            let endpoint = currentTab === 'video' ? "/v1/video/sora-video" : "/v1/draw/nano-banana";
            try {
                const res = await fetch(API_HOST + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if(data.code === 0) {
                    updateTask(taskId, { realId: data.data.id });
                    poll(data.data.id, taskId, key);
                } else {
                    updateTask(taskId, { status: 'failed', error: data.msg });
                }
            } catch (e) {
                updateTask(taskId, { status: 'failed', error: "APIè¿æ¥å¤±è´¥" });
            }
        }

        function poll(realId, taskId, key) {
            const timer = setInterval(async () => {
                const res = await fetch(API_HOST + "/v1/draw/result", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({ id: realId })
                });
                const resData = await res.json();
                if(resData.code !== 0) return;

                const info = resData.data;
                const bar = document.getElementById(`bar-${taskId}`);
                if(bar) bar.style.width = info.progress + "%";

                if(info.status === "succeeded") {
                    clearInterval(timer);
                    const url = info.results[0].url;
                    updateTask(taskId, { status: 'succeeded', url, progress: 100 });
                    autoDownload(url, taskId);
                } else if(info.status === "failed") {
                    clearInterval(timer);
                    updateTask(taskId, { status: 'failed' });
                }
            }, 4000);
        }

        function updateTask(id, data) {
            tasks = tasks.map(t => t.id === id ? {...t, ...data} : t);
            localStorage.setItem('grsai_tasks_v4', JSON.stringify(tasks));
            renderAllTasks();
        }

        function renderAllTasks() {
            const grid = document.getElementById('taskGrid');
            grid.innerHTML = tasks.map(t => `
                <div class="task-card bg-white p-4 rounded-xl border border-slate-200">
                    <div class="flex justify-between text-[10px] mb-2 font-bold uppercase">
                        <span class="${t.type==='video'?'text-purple-500':'text-orange-500'}">${t.type}</span>
                        <span class="${t.status==='succeeded'?'text-green-500':'text-blue-500'}">${t.status}</span>
                    </div>
                    <p class="text-[11px] text-slate-600 truncate mb-2" title="${t.prompt}">${t.prompt}</p>
                    <div class="media-box">
                        ${t.status === 'succeeded' 
                            ? (t.url.includes('.mp4') ? `<video src="${t.url}" controls></video>` : `<img src="${t.url}">`)
                            : `<div class="w-full px-8 text-center">
                                <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mb-2">
                                    <div id="bar-${t.id}" class="bg-indigo-600 h-full transition-all duration-500" style="width:${t.progress}%"></div>
                                </div>
                                <span class="text-[10px] text-slate-400 font-mono">${t.progress}%</span>
                               </div>`
                        }
                    </div>
                </div>
            `).join('');
        }

        async function fileToBase64(file) { return new Promise(r => { const f=new FileReader(); f.onload=()=>r(f.result); f.readAsDataURL(file); }); }
        
        async function autoDownload(url, name) {
            try {
                const res = await fetch(url);
                const blob = await res.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `AI_EXPORT_${Date.now()}.${url.includes('.mp4')?'mp4':'jpg'}`;
                a.click();
            } catch (e) { console.log("ä¸‹è½½å¤±è´¥"); }
        }

        function clearHistory() { if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰ç”Ÿæˆè®°å½•å—ï¼Ÿ")) { tasks=[]; localStorage.removeItem('grsai_tasks_v4'); renderAllTasks(); } }
        window.onload = renderAllTasks;
    </script>
</body>
</html>

